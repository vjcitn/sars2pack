---
title: "covidactnow interface"
author: "Vincent J. Carey, stvjc at channing.harvard.edu"
date: "`r format(Sys.time(), '%B %d, %Y')`"
vignette: >
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteIndexEntry{covidactnow interface}
  %\VignetteEncoding{UTF-8}
output:
  BiocStyle::html_document:
    highlight: pygments
    number_sections: yes
    theme: united
    toc: yes
---

# Introduction

From the covidactnow.org [about page](https://covidactnow.org/about):
Covid Act Now is an independent 501(c)(3) nonprofit founded by volunteers in March 2020.
A data API is available but requires a token for authentication.  To use
the function described in this vignette, it is assumed that the value of the environment
variable `COVACT_KEY` is this token.

Currently `sars2pack` exposes time-series data aggregated at the state level.

# Characteristics of the dataset

```{r lk1}
suppressPackageStartupMessages({
library(sars2pack)
library(dplyr)
library(magrittr)
library(DT)
library(lubridate)
library(ggplot2)
})
```
The following code requires an API key.
```{r showsum,eval=FALSE}
cc = covact_states_data()
dim(cc)
n = names(cc)
narate = vapply(n, function(x) mean(is.na(cc[[x]])), numeric(1))
cc21 = cc %>% filter(date >= "2021-01-01")
narate21 = vapply(n, function(x) mean(is.na(cc21[[x]])), numeric(1))
```
The following table enumerates available variables, overall
proportion of records missing, and proportion records missing for observations in 2021.
This is based on a snapshot, 28 March 2021.
```{r lkna}
data(covact_vbls)
datatable(covact_vbls)
```

# Example: identifying 2021 reversals

The national trend in early 2021 was reduction in COVID-19 incidence and
hospitalization.  This has reversed for some states starting around
March 2021.  To discover such states we'll use a very crude approach:
test for a quadratic component of the regression against
time of the mean value of COVID-based
hospital beds in use, as reported by covidactnow.org, confining attention
to observations in 2021.

The following code would require an API key to be present
if `cc` were to be used.  We use instead a snapshot made 28 March 2021.
```{r dolm}
# curhosp = filter(cc, date>="2021-01-01")
data(covact_st) # snapshot
curhosp = dplyr::filter(covact_st, date >= "2021-01-01")
curhosp$days = curhosp$date - as_date("2021-01-01")
curhosp$ndays = as.numeric(curhosp$days)
lm2 = lm( actuals.hospitalBeds.currentUsageCovid ~poly(ndays,2)*factor(state), data=curhosp) 
myco = summary(lm2)$coef 
inds = grep("2:factor", rownames(myco))
qeff = myco[inds,]
options(digits=3)
head(qeff[order(abs(qeff[, "t value"]), decreasing=TRUE),],10)
```
Here we plot trajectories of reported hospital bed usage for COVID-19
patients as reported by covidactnow.org.

```{r newf}
st4 = c("PA","MI", "OH", "TN", "IL", "IN", "NJ", "MN")
ggplot(curhosp[which(curhosp$state %in% st4),], aes(
   x=date, y=actuals.hospitalBeds.currentUsageCovid, colour=state)) + geom_line(lwd=2) + scale_y_log10() +
  ylab("hospital beds in use with covid patients") + xlab("2021")
```
 
